<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cadastro - Moeda Estudantil</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="container">
        <header>
            <h1>üìù Cadastrar</h1>
            <p>Crie sua conta no sistema</p>
        </header>
        <div class="form-container">
            <form id="registerForm" class="form">
                <div class="form-group">
                    <label for="tipo">Tipo</label>
                    <select id="tipo" name="tipo" required>
                        <option value="">Selecione...</option>
                        <option value="ALUNO">Aluno</option>
                        <!--<option value="PROFESSOR">Professor</option>-->
                        <option value="EMPRESA">Empresa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nome">Nome</label>
                    <input id="nome" name="nome" type="text" required />
                </div>
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input id="email" name="email" type="email" required />
                </div>
                <div class="form-group">
                    <label for="senha">Senha</label>
                    <input id="senha" name="senha" type="password" required />
                </div>

                <!-- Campos adicionais para ALUNO / EMPRESA podem ser exibidos via JS -->
                <div id="extra-fields"></div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                    <a href="login.html" class="btn btn-secondary">Voltar</a>
                </div>
            </form>
            <div id="message" class="message"></div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="auth.js"></script>
    <script>
        const tipoSelect = document.getElementById('tipo');
        const extra = document.getElementById('extra-fields');

        // Carrega institui√ß√µes do backend e retorna array
        async function fetchInstituicoes() {
            try {
                const lista = await api.getInstituicoes();
                return Array.isArray(lista) ? lista : [];
            } catch (e) {
                console.warn('N√£o foi poss√≠vel carregar institui√ß√µes:', e.message || e);
                return [];
            }
        }

        async function renderExtraFields(tipo) {
            extra.innerHTML = '';
            const instituicoes = await fetchInstituicoes();

            function buildInstituicaoSelect() {
                const selectId = 'instituicaoId';
                const options = instituicoes.map(inst => `
                    <option value="${inst.id}">${inst.nome}</option>
                `).join('\n');
                return `
                    <div class="form-group">
                        <label for="${selectId}">Institui√ß√£o</label>
                        <select id="${selectId}" name="${selectId}" required>
                            <option value="">Selecione...</option>
                            ${options}
                        </select>
                    </div>
                `;
            }

            if (tipo === 'ALUNO') {
                extra.innerHTML = `
                    ${buildInstituicaoSelect()}
                    <div class="form-group"><label for="cpf">CPF</label><input id="cpf" name="cpf" type="text" required /></div>
                    <div class="form-group"><label for="rg">RG</label><input id="rg" name="rg" type="text" required /></div>
                    <div class="form-group"><label for="curso">Curso</label><input id="curso" name="curso" type="text" required /></div>
                    <div class="form-group"><label for="endereco">Endere√ßo</label><input id="endereco" name="endereco" type="text" /></div>
                `;
            } else if (tipo === 'EMPRESA') {
                extra.innerHTML = `
                    <div class="form-group"><label for="cnpj">CNPJ</label><input id="cnpj" name="cnpj" type="text" required /></div>
                `;
            }
        }

        tipoSelect.addEventListener('change', (e) => {
            const tipo = tipoSelect.value;
            // renderExtraFields lida com fetch de institui√ß√µes
            renderExtraFields(tipo);
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = new FormData(e.target);
            const tipo = data.get('tipo');
            const payload = {
                tipo,
                nome: data.get('nome').trim(),
                email: data.get('email').trim(),
                senha: data.get('senha')
            };

            // Adiciona instituicaoId quando aplic√°vel
            const instituicaoId = data.get('instituicaoId');
            if (instituicaoId) {
                // envia como n√∫mero quando poss√≠vel
                payload.instituicaoId = isNaN(instituicaoId) ? instituicaoId : Number(instituicaoId);
            }

            if (tipo === 'ALUNO') {
                payload.endereco = data.get('endereco') ? data.get('endereco').trim() : '';
                payload.cpf = data.get('cpf') ? data.get('cpf').replace(/\D/g,'') : '';
                payload.rg = data.get('rg') ? data.get('rg').trim() : '';
                payload.curso = data.get('curso') ? data.get('curso').trim() : '';
            } else if (tipo === 'EMPRESA') {
                payload.cnpj = data.get('cnpj') ? data.get('cnpj').replace(/\D/g,'') : '';
            }

            try {
                console.log('Enviando payload de registro:', payload);

                const resp = await api.register(payload);
                // Se resposta retornar token -> login autom√°tico
                if (resp && resp.token) {
                    auth.setAuth(resp);
                    window.location.href = 'index.html';
                    return;
                }
                const msg = document.getElementById('message');
                msg.textContent = 'Cadastro realizado. Fa√ßa login.';
                msg.className = 'message success';
                msg.style.display = 'block';
                setTimeout(() => window.location.href = 'login.html', 1500);
            } catch (err) {
                const msg = document.getElementById('message');
                msg.textContent = err.message || 'Erro ao cadastrar';
                msg.className = 'message error';
                msg.style.display = 'block';
            }
        });
    </script>
</body>
</html>
